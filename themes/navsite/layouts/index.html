{{ define "main" }}
{{/* 聚合所有 links 页面内的工具 */}}
{{ $scratch := newScratch }}
{{ range $p := where .Site.RegularPages "Section" "links" }}
  {{ $cat := or $p.Params.category (index $p.Params.tags 0) }}
  {{ with $p.Params.tags }}{{ range . }}{{ $scratch.Add "allTags" (slice .) }}{{ end }}{{ end }}
  {{ with $cat }}{{ $scratch.Add "categories" (slice .) }}{{ end }}
  {{ with $p.Params.links }}
    {{ range . }}
      {{ $scratch.Add "items" (slice (dict
        "title" .name
        "desc" .desc
        "url" .url
        "tags" .tags
        "logo" .logo
        "cat" $cat
        "date" $p.Date
      )) }}
      {{ with .tags }}{{ range . }}{{ $scratch.Add "allTags" (slice .) }}{{ end }}{{ end }}
    {{ end }}
  {{ end }}
{{ end }}
{{ $items := sort ($scratch.Get "items" | default slice) "date" "desc" }}
{{ $totalLinks := len $items }}
{{ $tags := sort (uniq ($scratch.Get "allTags" | default (slice))) }}
{{ $categories := sort (uniq ($scratch.Get "categories" | default (slice))) }}

<section class="hero panel">
  <div class="hero__badge">导航精选</div>
  <h1 class="hero__title">{{ .Site.Title }}</h1>

  <div class="filter-bar">
    <div class="filter-row">
      <div class="filter-title">搜索</div>
      <input id="tool-search" class="search-input" type="search" placeholder="搜索名称 / 标签" />
    </div>
    <div class="filter-row">
      <div class="filter-title">分类筛选</div>
      <div class="tag-cloud" id="category-filter">
        <button class="tag-pill is-active" data-filter="all">All</button>
        {{ range $categories }}
          <button class="tag-pill" data-filter="{{ . | urlize }}">{{ . }}</button>
        {{ end }}
      </div>
    </div>
    <div class="filter-row">
      <div class="filter-title">排序</div>
      <div class="sort-tabs" id="sort-tabs">
        <button class="sort-tab is-active" data-sort="default">默认</button>
        <button class="sort-tab" data-sort="date">最新</button>
        <button class="sort-tab" data-sort="popular">最受欢迎</button>
        <button class="sort-tab" data-sort="alpha">字母顺序</button>
      </div>
    </div>
    {{ if gt (len $tags) 0 }}
    <div class="filter-row">
      <div class="filter-title">全站标签</div>
      <div class="tag-cloud tag-cloud--muted">
        {{ range $tags }}
          <span class="tag-chip">{{ . }}</span>
        {{ end }}
      </div>
    </div>
    {{ end }}
  </div>
</section>

{{ if gt (len $items) 0 }}
<section class="panel">
  <div class="section-title">
    <h2>工具列表</h2>
    <a class="ghost-link" href="{{ "/links/" | relURL }}">查看全部</a>
  </div>
  <div class="card-grid tool-grid" id="tool-grid">
    {{ range $items }}
      {{ $logo := .logo }}
      {{ $title := .title }}
      <a class="card card--tool"
        href="{{ .url }}"
        target="_blank"
        rel="noopener"
        data-category="{{ .cat | urlize }}"
        data-title="{{ $title }}"
        data-tags="{{ with .tags }}{{ delimit . " " | urlize }}{{ end }}"
        data-date="{{ .date.Format "2006-01-02" }}"
        data-popular="{{ or .popularity 0 }}">
        <div class="card__header">
          <span class="card__logo">
            {{ with $logo }}
              <img src="{{ . }}" alt="{{ $title }} logo" loading="lazy">
            {{ else }}
              <span class="logo-fallback">{{ substr $title 0 1 }}</span>
            {{ end }}
          </span>
          <div class="pill">{{ .cat | default "未分类" }}</div>
        </div>
        <div class="card__title">{{ $title }}</div>
      </a>
    {{ end }}
  </div>
</section>
{{ end }}

{{ $posts := where .Site.RegularPages "Section" "posts" }}
{{ if gt (len $posts) 0 }}
<section class="panel">
  <div class="section-title">
    <h2>更新</h2>
    <a class="ghost-link" href="{{ "/posts/" | relURL }}">更多</a>
  </div>
  <div class="card-grid">
    {{ range first 6 (sort $posts "Date" "desc") }}
      <a class="card" href="{{ .RelPermalink }}">
        <div class="card__header">
          <div class="pill pill--muted">{{ .Date.Format "2006-01-02" }}</div>
        </div>
        <div class="card__title">{{ .Title }}</div>
        {{ with .Summary }}<p class="card__desc">{{ . | plainify | truncate 120 }}</p>{{ end }}
      </a>
    {{ end }}
  </div>
</section>
{{ end }}
{{ end }}


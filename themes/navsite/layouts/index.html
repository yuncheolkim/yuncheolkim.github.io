{{ define "main" }}
{{/* 聚合所有 links 页面内的工具 */}}
{{ $scratch := newScratch }}
{{ range $p := where .Site.RegularPages "Section" "links" }}
  {{ $cat := or $p.Params.category (index $p.Params.tags 0) }}
  {{ $weight := $p.Params.sort_weight | default 999 }}
  {{ with $p.Params.tags }}{{ range . }}{{ $scratch.Add "allTags" (slice .) }}{{ end }}{{ end }}
  {{ with $cat }}
    {{ $scratch.Add "categoryData" (slice (dict "name" . "weight" $weight)) }}
  {{ end }}
  {{ with $p.Params.links }}
    {{ range . }}
      {{ $scratch.Add "items" (slice (dict
        "title" .name
        "desc" .desc
        "url" .url
        "tags" .tags
        "logo" .logo
        "cat" $cat
        "date" $p.Date
      )) }}
      {{ with .tags }}{{ range . }}{{ $scratch.Add "allTags" (slice .) }}{{ end }}{{ end }}
    {{ end }}
  {{ end }}
{{ end }}
{{ $items := sort ($scratch.Get "items" | default slice) "date" "desc" }}
{{ $totalLinks := len $items }}
{{ $tags := sort (uniq ($scratch.Get "allTags" | default (slice))) }}
{{ $categoryData := $scratch.Get "categoryData" | default slice }}
{{ $categoryMap := dict }}
{{ range $categoryData }}
  {{ $name := .name }}
  {{ $weight := .weight }}
  {{ $existing := index $categoryMap $name }}
  {{ if not $existing }}
    {{ $categoryMap = merge $categoryMap (dict $name $weight) }}
  {{ else if lt $weight $existing }}
    {{ $categoryMap = merge $categoryMap (dict $name $weight) }}
  {{ end }}
{{ end }}
{{ $categories := slice }}
{{ range $categoryData }}
  {{ $name := .name }}
  {{ $found := false }}
  {{ range $categories }}
    {{ if eq .name $name }}{{ $found = true }}{{ end }}
  {{ end }}
  {{ if not $found }}
    {{ $weight := index $categoryMap $name }}
    {{ $categories = $categories | append (dict "name" $name "weight" $weight) }}
  {{ end }}
{{ end }}
{{ $categories = sort $categories "weight" }}
{{ $categoryNames := slice }}
{{ range $categories }}
  {{ $categoryNames = $categoryNames | append .name }}
{{ end }}

<section class="hero panel">
  <h1 class="hero__title">{{ .Site.Title }}</h1>

  <div class="filter-bar">
    <div class="filter-row">
      <div class="filter-title">搜索</div>
      <input id="tool-search" class="search-input" type="search" placeholder="搜索名称 / 标签" />
    </div>
    <div class="filter-row">
      <div class="filter-title">分类筛选</div>
      <div class="tag-cloud" id="category-filter">
        <button class="tag-pill is-active" data-filter="all">All</button>
        {{ range $categoryNames }}
          <button class="tag-pill" data-filter="{{ . | urlize }}">{{ . }}</button>
        {{ end }}
      </div>
    </div>

    {{ if gt (len $tags) 0 }}
    <div class="filter-row">
      <div class="filter-title">标签筛选</div>
      <div class="tag-cloud" id="tag-filter">
        <button class="tag-pill is-active" data-tag="all">All</button>
        {{ range $tags }}
          <button class="tag-pill" data-tag="{{ . | urlize }}">{{ . }}</button>
        {{ end }}
      </div>
    </div>

    {{ end }}
  </div>
</section>

{{ if gt (len $items) 0 }}
<section class="panel">
  <div class="section-title">
    <h2>工具列表</h2>
  </div>
  <div class="card-grid tool-grid" id="tool-grid">
    {{ range $items }}
      {{ $logo := .logo }}
      {{ $title := .title }}
      <a class="card card--tool"
        href="{{ .url }}"
        target="_blank"
        rel="noopener"
        data-category="{{ .cat | urlize }}"
        data-title="{{ $title }}"
        data-tags="{{ with .tags }}{{ range $i, $t := . }}{{ if $i }} {{ end }}{{ $t | urlize }}{{ end }}{{ end }}"
        data-date="{{ .date.Format "2006-01-02" }}"
        data-popular="{{ or .popularity 0 }}">
        <div class="card__header">
          <span class="card__logo">
            {{ with $logo }}
              <img src="{{ . }}" alt="{{ $title }} logo" loading="lazy">
            {{ else }}
              <span class="logo-fallback">{{ substr $title 0 1 }}</span>
            {{ end }}
          </span>
          <div class="pill">{{ .cat | default "未分类" }}</div>
        </div>
        <div class="card__title">{{ $title }}</div>
        {{ with .desc }}<p class="card__desc">{{ . }}</p>{{ end }}
        {{ with .tags }}
          <div class="tag-row">
            {{ range first 4 . }}
              <span class="tag-badge">{{ . }}</span>
            {{ end }}
            {{ if gt (len .) 4 }}<span class="tag-badge tag-badge--muted">+{{ sub (len .) 4 }}</span>{{ end }}
          </div>
        {{ end }}
      </a>
    {{ end }}
  </div>
</section>
{{ end }}

{{ $posts := where .Site.RegularPages "Section" "posts" }}
{{ if gt (len $posts) 0 }}
<section class="panel">
  <div class="section-title">
    <h2>博客</h2>
    <a class="ghost-link" href="{{ "/posts/" | relURL }}">更多</a>
  </div>
  <div class="card-grid">
    {{ range first 6 (sort $posts "Date" "desc") }}
      <a class="card" href="{{ .RelPermalink }}">
        <div class="card__header">
          <div class="pill pill--muted">{{ .Date.Format "2006-01-02" }}</div>
        </div>
        <div class="card__title">{{ .Title }}</div>
        {{ with .Summary }}<p class="card__desc">{{ . | plainify | truncate 120 }}</p>{{ end }}
      </a>
    {{ end }}
  </div>
</section>
{{ end }}
{{ end }}


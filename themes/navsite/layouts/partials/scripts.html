<script>
  (() => {
    const grid = document.querySelector("#tool-grid");
    if (!grid) return;

    const cards = Array.from(grid.querySelectorAll(".card--tool"));
    const categoryButtons = Array.from(
      document.querySelectorAll("#category-filter .tag-pill")
    );
    const sortButtons = Array.from(
      document.querySelectorAll("#sort-tabs .sort-tab")
    );

    const toggleActive = (btn, on) => {
      btn.classList.toggle("is-active", on);
    };

    const applyFilterSort = (categories, sortKey) => {
      const filtered = cards.filter((card) => {
        if (!categories || categories.size === 0 || categories.has("all")) return true;
        return categories.has(card.dataset.category);
      });

      const sorted = filtered.sort((a, b) => {
        if (sortKey === "date") {
          return (
            new Date(b.dataset.date || 0).getTime() -
            new Date(a.dataset.date || 0).getTime()
          );
        }
        if (sortKey === "popular") {
          return (parseInt(b.dataset.popular || "0", 10) || 0) -
                 (parseInt(a.dataset.popular || "0", 10) || 0);
        }
        if (sortKey === "alpha") {
          return (a.dataset.title || "").localeCompare(b.dataset.title || "");
        }
        return 0; // default
      });

      // hide all first
      cards.forEach((c) => (c.style.display = "none"));
      sorted.forEach((c) => (c.style.display = ""));
      grid.classList.toggle("empty", sorted.length === 0);
    };

    // init
    const selectedCats = new Set(["all"]);
    applyFilterSort(selectedCats, "default");

    categoryButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const cat = btn.dataset.filter;
        if (cat === "all") {
          selectedCats.clear();
          selectedCats.add("all");
          categoryButtons.forEach((b) => toggleActive(b, b.dataset.filter === "all"));
        } else {
          // toggle selection
          if (selectedCats.has("all")) selectedCats.delete("all");
          if (selectedCats.has(cat)) {
            selectedCats.delete(cat);
          } else {
            selectedCats.add(cat);
          }
          // if none selected, fallback to all
          if (selectedCats.size === 0) selectedCats.add("all");
          categoryButtons.forEach((b) =>
            toggleActive(b, selectedCats.has(b.dataset.filter))
          );
        }

        const currentSort =
          sortButtons.find((b) => b.classList.contains("is-active"))?.dataset
            .sort || "default";
        applyFilterSort(selectedCats, currentSort);
      });
    });

    sortButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        sortButtons.forEach((b) => toggleActive(b, b === btn));
        const currentFilter =
          categoryButtons
            .filter((b) => b.classList.contains("is-active"))
            .map((b) => b.dataset.filter);
        const catSet = new Set(currentFilter.length ? currentFilter : ["all"]);
        applyFilterSort(catSet, btn.dataset.sort);
      });
    });
  })();
</script>


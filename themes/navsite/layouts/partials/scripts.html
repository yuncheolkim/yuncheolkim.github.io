<script>
  (() => {
    const grid = document.querySelector("#tool-grid");
    if (!grid) return;

    const cards = Array.from(grid.querySelectorAll(".card--tool"));
    const categoryButtons = Array.from(
      document.querySelectorAll("#category-filter .tag-pill")
    );
    const tagButtons = Array.from(
      document.querySelectorAll("#tag-filter .tag-pill")
    );
    const sortButtons = Array.from(
      document.querySelectorAll("#sort-tabs .sort-tab")
    );
    const searchBox = document.querySelector("#tool-search");

    const toggleActive = (btn, on) => {
      btn.classList.toggle("is-active", on);
    };

    const applyFilterSort = (categories, tags, sortKey, keyword) => {
      const kw = (keyword || "").trim().toLowerCase();

      const filtered = cards.filter((card) => {
        const catOk =
          !categories || categories.size === 0 || categories.has("all") || categories.has(card.dataset.category);
        if (!catOk) return false;

        if (tags && tags.size > 0 && !tags.has("all")) {
          const cardTags = new Set((card.dataset.tags || "").split(" ").filter(Boolean));
          const hit = Array.from(tags).some((t) => cardTags.has(t));
          if (!hit) return false;
        }

        if (kw.length === 0) return true;
        const title = (card.dataset.title || "").toLowerCase();
        const cardTagsStr = (card.dataset.tags || "").toLowerCase();
        return title.includes(kw) || cardTagsStr.includes(kw);
      });

      const sorted = filtered.sort((a, b) => {
        if (sortKey === "date") {
          return (
            new Date(b.dataset.date || 0).getTime() -
            new Date(a.dataset.date || 0).getTime()
          );
        }
        if (sortKey === "popular") {
          return (parseInt(b.dataset.popular || "0", 10) || 0) -
                 (parseInt(a.dataset.popular || "0", 10) || 0);
        }
        if (sortKey === "alpha") {
          return (a.dataset.title || "").localeCompare(b.dataset.title || "");
        }
        return 0; // default
      });

      // hide all first
      cards.forEach((c) => (c.style.display = "none"));
      sorted.forEach((c) => (c.style.display = ""));
      grid.classList.toggle("empty", sorted.length === 0);
    };

    // init
    const selectedCats = new Set(["all"]);
    const selectedTags = new Set(["all"]);
    let currentKeyword = "";
    applyFilterSort(selectedCats, selectedTags, "default", currentKeyword);

    categoryButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const cat = btn.dataset.filter;
        
        selectedCats.clear();
        selectedCats.add(cat);
        
        categoryButtons.forEach((b) =>
          toggleActive(b, b.dataset.filter === cat)
        );

        const currentSort =
          sortButtons.find((b) => b.classList.contains("is-active"))?.dataset
            .sort || "default";
        applyFilterSort(selectedCats, selectedTags, currentSort, currentKeyword);
      });
    });

    tagButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tag = btn.dataset.tag;
        if (tag === "all") {
          selectedTags.clear();
          selectedTags.add("all");
          tagButtons.forEach((b) => toggleActive(b, b.dataset.tag === "all"));
        } else {
          if (selectedTags.has("all")) selectedTags.delete("all");
          if (selectedTags.has(tag)) {
            selectedTags.delete(tag);
          } else {
            selectedTags.add(tag);
          }
          if (selectedTags.size === 0) selectedTags.add("all");
          tagButtons.forEach((b) =>
            toggleActive(b, selectedTags.has(b.dataset.tag))
          );
        }

        const currentSort =
          sortButtons.find((b) => b.classList.contains("is-active"))?.dataset
            .sort || "default";
        applyFilterSort(selectedCats, selectedTags, currentSort, currentKeyword);
      });
    });

    sortButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        sortButtons.forEach((b) => toggleActive(b, b === btn));
        const currentFilter =
          categoryButtons
            .filter((b) => b.classList.contains("is-active"))
            .map((b) => b.dataset.filter);
        const catSet = new Set(currentFilter.length ? currentFilter : ["all"]);
        applyFilterSort(catSet, selectedTags, btn.dataset.sort, currentKeyword);
      });
    });

    if (searchBox) {
      searchBox.addEventListener("input", () => {
        currentKeyword = searchBox.value || "";
        const currentSort =
          sortButtons.find((b) => b.classList.contains("is-active"))?.dataset
            .sort || "default";
        const currentFilter =
          categoryButtons
            .filter((b) => b.classList.contains("is-active"))
            .map((b) => b.dataset.filter);
        const catSet = new Set(currentFilter.length ? currentFilter : ["all"]);
        applyFilterSort(catSet, selectedTags, currentSort, currentKeyword);
      });
    }
  })();
</script>


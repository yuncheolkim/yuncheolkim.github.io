{{ define "main" }}
{{ $allPosts := (where .Site.RegularPages "Section" "posts").ByDate.Reverse }}
{{ $recentPosts := first 8 $allPosts }}

{{/* ä» posts æ–‡ç« ä¸­æ”¶é›†åˆ†ç±»å’Œæ ‡ç­¾ */}}
{{ $scratch := newScratch }}
{{ range $allPosts }}
  {{ with .Params.categories }}
    {{ range . }}
      {{ $scratch.Add "categories" (slice .) }}
    {{ end }}
  {{ end }}
  {{ with .Params.tags }}
    {{ range . }}
      {{ $scratch.Add "tags" (slice .) }}
    {{ end }}
  {{ end }}
{{ end }}
{{ $postCategories := uniq ($scratch.Get "categories") }}
{{ $postTags := uniq ($scratch.Get "tags") }}

<div class="blog-layout">
  <aside class="blog-sidebar">
    {{/* æœ€æ–°æ–‡ç« åŒºå— */}}
    <div class="panel sidebar-section">
      <h2 class="sidebar-section__title">ğŸ“„ æœ€æ–°æ–‡ç« </h2>
      <nav class="blog-sidebar__list">
        {{ range $recentPosts }}
          <a class="blog-sidebar__item {{ if eq .RelPermalink $.RelPermalink }}is-active{{ end }}" href="{{ .RelPermalink }}">
            <div class="blog-sidebar__item-title">{{ .Title }}</div>
            <div class="blog-sidebar__item-meta">
              <time>{{ .Date.Format "2006-01-02" }}</time>
            </div>
          </a>
        {{ end }}
      </nav>
      <div class="blog-sidebar__footer">
        <a class="ghost-link" href="{{ "/posts/" | relURL }}">æŸ¥çœ‹å…¨éƒ¨ ({{ len $allPosts }})</a>
      </div>
    </div>

    {{/* åˆ†ç±»åŒºå— */}}
    {{ if $postCategories }}
    <div class="panel sidebar-section">
      <h2 class="sidebar-section__title">ğŸ“ åˆ†ç±»</h2>
      <nav class="category-list">
        <a class="category-list__item" href="{{ "/posts/" | relURL }}">
          <span class="category-list__name">å…¨éƒ¨</span>
          <span class="category-list__count">{{ len $allPosts }}</span>
        </a>
        {{ range $postCategories }}
          {{ $count := len (where $allPosts ".Params.categories" "intersect" (slice .)) }}
          <a class="category-list__item {{ if in $.Params.categories . }}is-active{{ end }}" href="{{ "/posts/" | relURL }}?category={{ urlize . }}">
            <span class="category-list__name">{{ . }}</span>
            <span class="category-list__count">{{ $count }}</span>
          </a>
        {{ end }}
      </nav>
    </div>
    {{ end }}

    {{/* æ ‡ç­¾åŒºå— */}}
    {{ if $postTags }}
    <div class="panel sidebar-section">
      <h2 class="sidebar-section__title">ğŸ·ï¸ æ ‡ç­¾</h2>
      <div class="filter-cloud">
        {{ range $postTags }}
          {{ $count := len (where $allPosts ".Params.tags" "intersect" (slice .)) }}
          <a class="filter-tag filter-tag--tag {{ if in $.Params.tags . }}is-active{{ end }}" href="{{ "/posts/" | relURL }}?tag={{ urlize . }}">
            <span class="filter-tag__name">{{ . }}</span>
            <span class="filter-tag__count">{{ $count }}</span>
          </a>
        {{ end }}
      </div>
    </div>
    {{ end }}
  </aside>

  <main class="blog-content">
    <article class="panel blog-post">
      <header class="blog-post__header">
        <h1 class="blog-post__title">{{ .Title }}</h1>
        <div class="blog-post__meta">
          <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "2006-01-02" }}</time>
          {{ with .Params.categories }}
            <span class="blog-post__categories">
              {{ range . }}<a class="category-badge" href="{{ (printf "/categories/%s/" (urlize .)) | relURL }}">{{ . }}</a>{{ end }}
            </span>
          {{ end }}
          {{ with .Params.tags }}
            <span class="blog-post__tags">
              {{ range . }}<a class="tag-badge" href="{{ (printf "/tags/%s/" (urlize .)) | relURL }}">{{ . }}</a>{{ end }}
            </span>
          {{ end }}
        </div>
        {{ with .Params.summary }}<p class="blog-post__subtitle">{{ . }}</p>{{ end }}
      </header>

      <div class="prose">
        {{ .Content }}
      </div>

      <footer class="blog-post__footer">
        <a class="ghost-link" href="{{ "/posts/" | relURL }}">â† è¿”å›åšå®¢</a>
      </footer>
    </article>
  </main>
</div>
{{ end }}

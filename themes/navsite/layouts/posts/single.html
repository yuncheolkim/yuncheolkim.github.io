{{ define "main" }}
{{ $allPosts := (where .Site.RegularPages "Section" "posts").ByDate.Reverse }}

{{/* è®¡ç®—å­—æ•°å’Œé˜…è¯»æ—¶é—´ï¼ˆä¸­æ–‡æŒ‰å­—ç¬¦æ•°ç»Ÿè®¡ï¼‰ */}}
{{ $content := .Plain }}
{{ $content = replaceRE "https?://[^\\s\\)\\]]*" "" $content }}
{{ $content = replaceRE "[\\s\\n\\r\\t]+" "" $content }}
{{ $wordCount := strings.RuneCount $content }}
{{ $readingTime := div $wordCount 300 }}
{{ if lt $readingTime 1 }}{{ $readingTime = 1 }}{{ end }}

{{/* æ£€æŸ¥æ˜¯å¦æœ‰ç›®å½•å†…å®¹ */}}
{{ $toc := .TableOfContents }}
{{ $hasToc := gt (len (findRE "<li" $toc)) 0 }}

{{/* è·å–ä¸Šä¸€ç¯‡å’Œä¸‹ä¸€ç¯‡æ–‡ç«  */}}
{{ $currentIndex := 0 }}
{{ range $index, $post := $allPosts }}
  {{ if eq $post.RelPermalink $.RelPermalink }}
    {{ $currentIndex = $index }}
  {{ end }}
{{ end }}
{{ $prevPost := index $allPosts (sub $currentIndex 1) }}
{{ $nextPost := index $allPosts (add $currentIndex 1) }}

<!-- é˜…è¯»è¿›åº¦æ¡ -->
<div class="reading-progress" id="reading-progress"></div>

<div class="reader-layout{{ if not $hasToc }} reader-layout--no-toc{{ end }}">
  <!-- å·¦ä¾§ç›®å½• -->
  {{ if $hasToc }}
  <aside class="toc-sidebar" id="toc-sidebar">
    <div class="toc-container">
      <h3 class="toc-title">ğŸ“‘ ç›®å½•</h3>
      <nav class="toc-nav" id="toc-nav">
        {{ .TableOfContents }}
      </nav>
      <div class="toc-footer">
        <a class="ghost-link" href="{{ "/posts/" | relURL }}">â† è¿”å›æ–‡ç« åˆ—è¡¨</a>
      </div>
    </div>
  </aside>
  {{ end }}

  <!-- ä¸»å†…å®¹åŒº -->
  <main class="reader-content">
    <article class="reader-article">
      <!-- æ–‡ç« å¤´éƒ¨ -->
      <header class="reader-header">
        <div class="reader-header__meta">
          {{ with .Params.categories }}
            {{ range . }}<a class="reader-category" href="{{ "/posts/" | relURL }}?category={{ urlize . }}">{{ . }}</a>{{ end }}
          {{ end }}
        </div>
        <h1 class="reader-header__title">{{ .Title }}</h1>
        {{ with .Params.summary }}<p class="reader-header__summary">{{ . }}</p>{{ end }}
        <div class="reader-header__info">
          <span class="reader-info-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            {{ .Date.Format "2006å¹´01æœˆ02æ—¥" }}
          </span>
          <span class="reader-info-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            çº¦ {{ $readingTime }} åˆ†é’Ÿé˜…è¯»
          </span>
          <span class="reader-info-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
            {{ $wordCount }} å­—
          </span>
        </div>
        {{ with .Params.tags }}
          <div class="reader-header__tags">
            {{ range . }}<a class="tag-badge" href="{{ "/posts/" | relURL }}?tag={{ urlize . }}">{{ . }}</a>{{ end }}
          </div>
        {{ end }}
      </header>

      <!-- æ–‡ç« å†…å®¹ -->
      <div class="reader-body">
        <div class="prose" id="article-content">
          {{ .Content }}
        </div>
      </div>

      <!-- æ–‡ç« åº•éƒ¨ -->
      <footer class="reader-footer">
        <!-- ä¸Šä¸‹ç¯‡å¯¼èˆª -->
        <nav class="article-nav">
          {{ if and $prevPost (gt $currentIndex 0) }}
            <a class="article-nav__item article-nav__prev" href="{{ $prevPost.RelPermalink }}">
              <span class="article-nav__label">ä¸Šä¸€ç¯‡</span>
              <span class="article-nav__title">{{ $prevPost.Title }}</span>
            </a>
          {{ else }}
            <div class="article-nav__item article-nav__prev article-nav__empty">
              <span class="article-nav__label">å·²æ˜¯æœ€æ–°</span>
            </div>
          {{ end }}
          
          {{ if and $nextPost (lt $currentIndex (sub (len $allPosts) 1)) }}
            <a class="article-nav__item article-nav__next" href="{{ $nextPost.RelPermalink }}">
              <span class="article-nav__label">ä¸‹ä¸€ç¯‡</span>
              <span class="article-nav__title">{{ $nextPost.Title }}</span>
            </a>
          {{ else }}
            <div class="article-nav__item article-nav__next article-nav__empty">
              <span class="article-nav__label">å·²æ˜¯æœ€å</span>
            </div>
          {{ end }}
        </nav>

        <div class="reader-footer__actions">
          <a class="reader-btn" href="{{ "/posts/" | relURL }}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            è¿”å›æ–‡ç« åˆ—è¡¨
          </a>
          <button class="reader-btn" id="scroll-top-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
            å›åˆ°é¡¶éƒ¨
          </button>
        </div>
      </footer>
    </article>
  </main>
</div>

<script>
(function() {
  // é˜…è¯»è¿›åº¦æ¡
  const progressBar = document.getElementById('reading-progress');
  const article = document.getElementById('article-content');
  
  function updateProgress() {
    const scrollTop = window.scrollY;
    const docHeight = document.documentElement.scrollHeight - window.innerHeight;
    const progress = (scrollTop / docHeight) * 100;
    progressBar.style.width = progress + '%';
  }
  
  window.addEventListener('scroll', updateProgress);
  updateProgress();
  
  // å›åˆ°é¡¶éƒ¨
  const scrollTopBtn = document.getElementById('scroll-top-btn');
  if (scrollTopBtn) {
    scrollTopBtn.addEventListener('click', function() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }
  
  // ç›®å½•é«˜äº®å½“å‰ç« èŠ‚
  const tocLinks = document.querySelectorAll('#toc-nav a');
  const headings = document.querySelectorAll('.prose h2, .prose h3');
  
  function updateTocHighlight() {
    let currentHeading = null;
    headings.forEach(heading => {
      if (heading.getBoundingClientRect().top <= 100) {
        currentHeading = heading;
      }
    });
    
    tocLinks.forEach(link => {
      link.classList.remove('is-active');
      if (currentHeading && link.getAttribute('href') === '#' + currentHeading.id) {
        link.classList.add('is-active');
      }
    });
  }
  
  window.addEventListener('scroll', updateTocHighlight);
  updateTocHighlight();
})();
</script>
{{ end }}

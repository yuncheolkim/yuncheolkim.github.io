{{ define "main" }}
{{ $p := .Paginate .Pages 10 }}
{{ $firstPost := index $p.Pages 0 }}
{{ $allPosts := (where $.Site.RegularPages "Section" "posts").ByDate.Reverse }}

{{/* ä» posts æ–‡ç« ä¸­æ”¶é›†åˆ†ç±» */}}
{{ $scratch := newScratch }}
{{ range $allPosts }}
  {{ with .Params.categories }}
    {{ range . }}
      {{ $scratch.Add "categories" (slice .) }}
    {{ end }}
  {{ end }}
  {{ with .Params.tags }}
    {{ range . }}
      {{ $scratch.Add "tags" (slice .) }}
    {{ end }}
  {{ end }}
{{ end }}
{{ $postCategories := uniq ($scratch.Get "categories") }}
{{ $postTags := uniq ($scratch.Get "tags") }}

<div class="blog-layout">
  <aside class="blog-sidebar">
    {{/* æœ€æ–°æ–‡ç« åŒºå— */}}
    <div class="panel sidebar-section">
      <h2 class="sidebar-section__title">ğŸ“„ æœ€æ–°æ–‡ç« </h2>
      <nav class="blog-sidebar__list">
        {{ range first 8 $allPosts }}
          <a class="blog-sidebar__item {{ if eq .RelPermalink $firstPost.RelPermalink }}is-active{{ end }}" href="{{ .RelPermalink }}">
            <div class="blog-sidebar__item-title">{{ .Title }}</div>
            <div class="blog-sidebar__item-meta">
              <time>{{ .Date.Format "2006-01-02" }}</time>
            </div>
          </a>
        {{ end }}
      </nav>
      {{ if gt (len $allPosts) 8 }}
        <div class="blog-sidebar__footer">
          <span class="ghost-link">å…± {{ len $allPosts }} ç¯‡æ–‡ç« </span>
        </div>
      {{ end }}
    </div>

    {{/* åˆ†ç±»åŒºå— */}}
    {{ if $postCategories }}
    <div class="panel sidebar-section">
      <h2 class="sidebar-section__title">ğŸ“ åˆ†ç±»</h2>
      <nav class="category-list">
        {{ range $postCategories }}
          {{ $count := len (where $allPosts ".Params.categories" "intersect" (slice .)) }}
          <a class="category-list__item" href="{{ (printf "/categories/%s/" (urlize .)) | relURL }}">
            <span class="category-list__name">{{ . }}</span>
            <span class="category-list__count">{{ $count }}</span>
          </a>
        {{ end }}
      </nav>
    </div>
    {{ end }}

    {{/* æ ‡ç­¾åŒºå— */}}
    {{ if $postTags }}
    <div class="panel sidebar-section">
      <h2 class="sidebar-section__title">ğŸ·ï¸ æ ‡ç­¾</h2>
      <div class="filter-cloud">
        {{ range $postTags }}
          {{ $count := len (where $allPosts ".Params.tags" "intersect" (slice .)) }}
          <a class="filter-tag filter-tag--tag" href="{{ (printf "/tags/%s/" (urlize .)) | relURL }}">
            <span class="filter-tag__name">{{ . }}</span>
            <span class="filter-tag__count">{{ $count }}</span>
          </a>
        {{ end }}
      </div>
    </div>
    {{ end }}

    {{/* åˆ†é¡µ */}}
    {{ if gt $p.TotalPages 1 }}
      <div class="panel sidebar-section">
        <div class="blog-sidebar__pagination">
          {{ if $p.HasPrev }}<a class="ghost-link" href="{{ $p.Prev.URL }}">Â« ä¸Šä¸€é¡µ</a>{{ end }}
          <span class="blog-pagination__info">ç¬¬ {{ $p.PageNumber }} / {{ $p.TotalPages }} é¡µ</span>
          {{ if $p.HasNext }}<a class="ghost-link" href="{{ $p.Next.URL }}">ä¸‹ä¸€é¡µ Â»</a>{{ end }}
        </div>
      </div>
    {{ end }}
  </aside>

  <main class="blog-content">
    {{ if $firstPost }}
      <article class="panel blog-post">
        <header class="blog-post__header">
          <h1 class="blog-post__title">{{ $firstPost.Title }}</h1>
          <div class="blog-post__meta">
            <time datetime="{{ $firstPost.Date.Format "2006-01-02" }}">{{ $firstPost.Date.Format "2006-01-02" }}</time>
            {{ with $firstPost.Params.categories }}
              <span class="blog-post__categories">
                {{ range . }}<a class="category-badge" href="{{ (printf "/categories/%s/" (urlize .)) | relURL }}">{{ . }}</a>{{ end }}
              </span>
            {{ end }}
            {{ with $firstPost.Params.tags }}
              <span class="blog-post__tags">
                {{ range . }}<a class="tag-badge" href="{{ (printf "/tags/%s/" (urlize .)) | relURL }}">{{ . }}</a>{{ end }}
              </span>
            {{ end }}
          </div>
          {{ with $firstPost.Params.summary }}<p class="blog-post__subtitle">{{ . }}</p>{{ end }}
        </header>

        <div class="prose">
          {{ $firstPost.Content }}
        </div>
      </article>
    {{ else }}
      <div class="panel">
        <p>æš‚æ— æ–‡ç« </p>
      </div>
    {{ end }}
  </main>
</div>
{{ end }}

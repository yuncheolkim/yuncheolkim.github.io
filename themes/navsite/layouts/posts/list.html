{{ define "main" }}
{{ $allPosts := (where $.Site.RegularPages "Section" "posts").ByDate.Reverse }}

{{/* ä» posts æ–‡ç« ä¸­æ”¶é›†åˆ†ç±» */}}
{{ $scratch := newScratch }}
{{ range $allPosts }}
  {{ with .Params.categories }}
    {{ range . }}
      {{ $scratch.Add "categories" (slice .) }}
    {{ end }}
  {{ end }}
  {{ with .Params.tags }}
    {{ range . }}
      {{ $scratch.Add "tags" (slice .) }}
    {{ end }}
  {{ end }}
{{ end }}
{{ $postCategories := uniq ($scratch.Get "categories") }}
{{ $postTags := uniq ($scratch.Get "tags") }}

<div class="blog-layout">
  <aside class="blog-sidebar">
    {{/* æœ€æ–°æ–‡ç« åŒºå— */}}
    <div class="panel sidebar-section">
      <h2 class="sidebar-section__title">ğŸ“„ æœ€æ–°æ–‡ç« </h2>
      <nav class="blog-sidebar__list">
        {{ range first 8 $allPosts }}
          <a class="blog-sidebar__item" href="{{ .RelPermalink }}">
            <div class="blog-sidebar__item-title">{{ .Title }}</div>
            <div class="blog-sidebar__item-meta">
              <time>{{ .Date.Format "2006-01-02" }}</time>
            </div>
          </a>
        {{ end }}
      </nav>
      {{ if gt (len $allPosts) 8 }}
        <div class="blog-sidebar__footer">
          <span class="ghost-link">å…± {{ len $allPosts }} ç¯‡æ–‡ç« </span>
        </div>
      {{ end }}
    </div>

    {{/* åˆ†ç±»åŒºå— */}}
    {{ if $postCategories }}
    <div class="panel sidebar-section">
      <h2 class="sidebar-section__title">ğŸ“ åˆ†ç±» <button class="filter-reset" id="reset-category" style="display:none;">æ¸…é™¤</button></h2>
      <nav class="category-list" id="category-filter">
        <button class="category-list__item is-active" data-category="all">
          <span class="category-list__name">å…¨éƒ¨</span>
          <span class="category-list__count">{{ len $allPosts }}</span>
        </button>
        {{ range $postCategories }}
          {{ $count := len (where $allPosts ".Params.categories" "intersect" (slice .)) }}
          <button class="category-list__item" data-category="{{ . }}">
            <span class="category-list__name">{{ . }}</span>
            <span class="category-list__count">{{ $count }}</span>
          </button>
        {{ end }}
      </nav>
    </div>
    {{ end }}

    {{/* æ ‡ç­¾åŒºå— */}}
    {{ if $postTags }}
    <div class="panel sidebar-section">
      <h2 class="sidebar-section__title">ğŸ·ï¸ æ ‡ç­¾ <button class="filter-reset" id="reset-tags" style="display:none;">æ¸…é™¤</button></h2>
      <div class="filter-cloud" id="tag-filter">
        {{ range $postTags }}
          {{ $count := len (where $allPosts ".Params.tags" "intersect" (slice .)) }}
          <button class="filter-tag filter-tag--tag" data-tag="{{ . }}">
            <span class="filter-tag__name">{{ . }}</span>
            <span class="filter-tag__count">{{ $count }}</span>
          </button>
        {{ end }}
      </div>
    </div>
    {{ end }}
  </aside>

  <main class="blog-content">
    <div class="panel">
      <div class="section-title">
        <h2>ğŸ“° <span id="filter-title">å…¨éƒ¨æ–‡ç« </span></h2>
        <span id="filter-count" class="filter-count">{{ len $allPosts }} ç¯‡</span>
      </div>
      
      {{ if $allPosts }}
        <div class="article-list" id="article-list">
          {{ range $allPosts }}
            <article class="article-card" 
              data-categories="{{ with .Params.categories }}{{ delimit . "," }}{{ end }}"
              data-tags="{{ with .Params.tags }}{{ delimit . "," }}{{ end }}">
              <header class="article-card__header">
                <h3 class="article-card__title">
                  <a href="{{ .RelPermalink }}">{{ .Title }}</a>
                </h3>
                <div class="article-card__meta">
                  <time datetime="{{ .Date.Format "2006-01-02" }}">ğŸ“… {{ .Date.Format "2006-01-02" }}</time>
                  {{ with .Params.categories }}
                    <span class="article-card__categories">
                      {{ range . }}<span class="category-badge">{{ . }}</span>{{ end }}
                    </span>
                  {{ end }}
                </div>
              </header>
              
              {{ with .Params.summary }}
                <p class="article-card__summary">{{ . }}</p>
              {{ else }}
                <p class="article-card__summary">{{ .Summary | plainify | truncate 120 }}</p>
              {{ end }}
              
              {{ with .Params.tags }}
                <div class="article-card__tags">
                  {{ range . }}<span class="tag-badge">{{ . }}</span>{{ end }}
                </div>
              {{ end }}
              
              <a class="article-card__readmore" href="{{ .RelPermalink }}">é˜…è¯»å…¨æ–‡ â†’</a>
            </article>
          {{ end }}
        </div>
        
        <div id="no-results" class="no-results" style="display:none;">
          <p>ğŸ˜” æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ–‡ç« </p>
        </div>
      {{ else }}
        <p>æš‚æ— æ–‡ç« </p>
      {{ end }}
    </div>
  </main>
</div>

<script>
(function() {
  let currentCategory = 'all';
  let selectedTags = new Set();
  
  const articles = document.querySelectorAll('.article-card');
  const categoryButtons = document.querySelectorAll('#category-filter .category-list__item');
  const tagButtons = document.querySelectorAll('#tag-filter .filter-tag');
  const filterTitle = document.getElementById('filter-title');
  const filterCount = document.getElementById('filter-count');
  const noResults = document.getElementById('no-results');
  const articleList = document.getElementById('article-list');
  const resetTagsBtn = document.getElementById('reset-tags');
  
  function filterArticles() {
    let visibleCount = 0;
    
    articles.forEach(article => {
      const articleCategories = article.dataset.categories ? article.dataset.categories.split(',') : [];
      const articleTags = article.dataset.tags ? article.dataset.tags.split(',') : [];
      
      // æ£€æŸ¥åˆ†ç±»
      const categoryMatch = currentCategory === 'all' || articleCategories.includes(currentCategory);
      
      // æ£€æŸ¥æ ‡ç­¾ï¼ˆå¦‚æœé€‰ä¸­äº†æ ‡ç­¾ï¼Œæ–‡ç« å¿…é¡»åŒ…å«æ‰€æœ‰é€‰ä¸­çš„æ ‡ç­¾ï¼‰
      let tagMatch = true;
      if (selectedTags.size > 0) {
        tagMatch = [...selectedTags].every(tag => articleTags.includes(tag));
      }
      
      if (categoryMatch && tagMatch) {
        article.style.display = '';
        visibleCount++;
      } else {
        article.style.display = 'none';
      }
    });
    
    // æ›´æ–°æ ‡é¢˜å’Œè®¡æ•°
    let titleParts = [];
    if (currentCategory !== 'all') {
      titleParts.push(currentCategory);
    }
    if (selectedTags.size > 0) {
      titleParts.push([...selectedTags].join(' + '));
    }
    
    filterTitle.textContent = titleParts.length > 0 ? titleParts.join(' / ') : 'å…¨éƒ¨æ–‡ç« ';
    filterCount.textContent = visibleCount + ' ç¯‡';
    
    // æ˜¾ç¤º/éšè—æ— ç»“æœæç¤º
    if (visibleCount === 0) {
      noResults.style.display = '';
      articleList.style.display = 'none';
    } else {
      noResults.style.display = 'none';
      articleList.style.display = '';
    }
    
    // æ˜¾ç¤º/éšè—æ¸…é™¤æ ‡ç­¾æŒ‰é’®
    if (resetTagsBtn) {
      resetTagsBtn.style.display = selectedTags.size > 0 ? '' : 'none';
    }
  }
  
  // åˆ†ç±»ç‚¹å‡»äº‹ä»¶
  categoryButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      categoryButtons.forEach(b => b.classList.remove('is-active'));
      this.classList.add('is-active');
      currentCategory = this.dataset.category;
      filterArticles();
    });
  });
  
  // æ ‡ç­¾ç‚¹å‡»äº‹ä»¶ï¼ˆå¤šé€‰ï¼‰
  tagButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const tag = this.dataset.tag;
      if (selectedTags.has(tag)) {
        selectedTags.delete(tag);
        this.classList.remove('is-active');
      } else {
        selectedTags.add(tag);
        this.classList.add('is-active');
      }
      filterArticles();
    });
  });
  
  // æ¸…é™¤æ ‡ç­¾æŒ‰é’®
  if (resetTagsBtn) {
    resetTagsBtn.addEventListener('click', function() {
      selectedTags.clear();
      tagButtons.forEach(btn => btn.classList.remove('is-active'));
      filterArticles();
    });
  }
})();
</script>
{{ end }}

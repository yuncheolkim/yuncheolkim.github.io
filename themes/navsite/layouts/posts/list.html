{{ define "main" }}
{{ $allPosts := (where $.Site.RegularPages "Section" "posts").ByDate.Reverse }}

{{/* ä» posts æ–‡ç« ä¸­æ”¶é›†åˆ†ç±» */}}
{{ $scratch := newScratch }}
{{ range $allPosts }}
  {{ with .Params.categories }}
    {{ range . }}
      {{ $scratch.Add "categories" (slice .) }}
    {{ end }}
  {{ end }}
  {{ with .Params.tags }}
    {{ range . }}
      {{ $scratch.Add "tags" (slice .) }}
    {{ end }}
  {{ end }}
{{ end }}
{{ $postCategories := uniq ($scratch.Get "categories") }}
{{ $postTags := uniq ($scratch.Get "tags") }}

<div class="blog-layout">
  <aside class="blog-sidebar">
    {{/* æœ€æ–°æ–‡ç« åŒºå— */}}
    <div class="panel sidebar-section">
      <h2 class="sidebar-section__title">ğŸ“„ æœ€æ–°æ–‡ç« </h2>
      <nav class="blog-sidebar__list">
        {{ range first 8 $allPosts }}
          <a class="blog-sidebar__item" href="{{ .RelPermalink }}">
            <div class="blog-sidebar__item-title">{{ .Title }}</div>
            <div class="blog-sidebar__item-meta">
              <time>{{ .Date.Format "2006-01-02" }}</time>
            </div>
          </a>
        {{ end }}
      </nav>
      {{ if gt (len $allPosts) 8 }}
        <div class="blog-sidebar__footer">
          <span class="ghost-link">å…± {{ len $allPosts }} ç¯‡æ–‡ç« </span>
        </div>
      {{ end }}
    </div>

    {{/* åˆ†ç±»åŒºå— */}}
    {{ if $postCategories }}
    <div class="panel sidebar-section">
      <h2 class="sidebar-section__title">ğŸ“ åˆ†ç±» <button class="filter-reset" id="reset-category" style="display:none;">æ¸…é™¤</button></h2>
      <nav class="category-list" id="category-filter">
        <button class="category-list__item is-active" data-category="all">
          <span class="category-list__name">å…¨éƒ¨</span>
          <span class="category-list__count">{{ len $allPosts }}</span>
        </button>
        {{ range $postCategories }}
          {{ $count := len (where $allPosts ".Params.categories" "intersect" (slice .)) }}
          <button class="category-list__item" data-category="{{ . }}">
            <span class="category-list__name">{{ . }}</span>
            <span class="category-list__count">{{ $count }}</span>
          </button>
        {{ end }}
      </nav>
    </div>
    {{ end }}

    {{/* æ ‡ç­¾åŒºå— */}}
    {{ if $postTags }}
    <div class="panel sidebar-section">
      <h2 class="sidebar-section__title">ğŸ·ï¸ æ ‡ç­¾ <button class="filter-reset" id="reset-tags" style="display:none;">æ¸…é™¤</button></h2>
      <div class="filter-cloud" id="tag-filter">
        {{ range $postTags }}
          {{ $count := len (where $allPosts ".Params.tags" "intersect" (slice .)) }}
          <button class="filter-tag filter-tag--tag" data-tag="{{ . }}">
            <span class="filter-tag__name">{{ . }}</span>
            <span class="filter-tag__count">{{ $count }}</span>
          </button>
        {{ end }}
      </div>
    </div>
    {{ end }}
  </aside>

  <main class="blog-content">
    <div class="panel">
      <div class="section-title">
        <h2>ğŸ“° <span id="filter-title">å…¨éƒ¨æ–‡ç« </span></h2>
        <span id="filter-count" class="filter-count">{{ len $allPosts }} ç¯‡</span>
      </div>
      
      <!-- æœç´¢æ¡† -->
      <div class="search-container">
        <div class="search-wrapper">
          <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.3-4.3"></path>
          </svg>
          <input type="text" id="articleSearch" class="search-input" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜ã€æ‘˜è¦ã€åˆ†ç±»æˆ–æ ‡ç­¾..." autocomplete="off">
          <button id="clearArticleSearch" class="search-clear" style="display: none;" title="æ¸…é™¤æœç´¢">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 6 6 18"></path>
              <path d="m6 6 12 12"></path>
            </svg>
          </button>
        </div>
      </div>
      
      {{ if $allPosts }}
        <div class="article-list" id="article-list">
          {{ range $allPosts }}
            {{ $summary := "" }}
            {{ if .Params.summary }}
              {{ $summary = .Params.summary }}
            {{ else }}
              {{ $summary = .Summary | plainify | truncate 120 }}
            {{ end }}
            <article class="article-card" 
              data-title="{{ .Title | lower }}"
              data-summary="{{ $summary | lower }}"
              data-categories="{{ with .Params.categories }}{{ delimit . "," | lower }}{{ end }}"
              data-tags="{{ with .Params.tags }}{{ delimit . "," | lower }}{{ end }}">
              <header class="article-card__header">
                <h3 class="article-card__title">
                  <a href="{{ .RelPermalink }}">{{ .Title }}</a>
                </h3>
                <div class="article-card__meta">
                  <time datetime="{{ .Date.Format "2006-01-02" }}">ğŸ“… {{ .Date.Format "2006-01-02" }}</time>
                  {{ with .Params.categories }}
                    <span class="article-card__categories">
                      {{ range . }}<span class="category-badge">{{ . }}</span>{{ end }}
                    </span>
                  {{ end }}
                </div>
              </header>
              
              {{ with .Params.summary }}
                <p class="article-card__summary">{{ . }}</p>
              {{ else }}
                <p class="article-card__summary">{{ .Summary | plainify | truncate 120 }}</p>
              {{ end }}
              
              {{ with .Params.tags }}
                <div class="article-card__tags">
                  {{ range . }}<span class="tag-badge">{{ . }}</span>{{ end }}
                </div>
              {{ end }}
              
              <a class="article-card__readmore" href="{{ .RelPermalink }}">é˜…è¯»å…¨æ–‡ â†’</a>
            </article>
          {{ end }}
        </div>
        
        <div id="no-results" class="no-results" style="display:none;">
          <p>ğŸ˜” æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ–‡ç« </p>
        </div>
      {{ else }}
        <p>æš‚æ— æ–‡ç« </p>
      {{ end }}
    </div>
  </main>
</div>

<script>
(function() {
  // è§£æ URL å‚æ•°
  const urlParams = new URLSearchParams(window.location.search);
  const urlCategory = urlParams.get('category');
  const urlTag = urlParams.get('tag');
  
  let currentCategory = urlCategory || 'all';
  let selectedTags = new Set();
  if (urlTag) {
    selectedTags.add(decodeURIComponent(urlTag));
  }
  let searchQuery = '';
  
  const articles = document.querySelectorAll('.article-card');
  const categoryButtons = document.querySelectorAll('#category-filter .category-list__item');
  const tagButtons = document.querySelectorAll('#tag-filter .filter-tag');
  const filterTitle = document.getElementById('filter-title');
  const filterCount = document.getElementById('filter-count');
  const noResults = document.getElementById('no-results');
  const articleList = document.getElementById('article-list');
  const resetCategoryBtn = document.getElementById('reset-category');
  const resetTagsBtn = document.getElementById('reset-tags');
  const searchInput = document.getElementById('articleSearch');
  const clearSearchBtn = document.getElementById('clearArticleSearch');
  
  // æ ¹æ® URL å‚æ•°è®¾ç½®åˆå§‹çŠ¶æ€
  if (urlCategory) {
    categoryButtons.forEach(btn => {
      btn.classList.remove('is-active');
      if (btn.dataset.category === urlCategory) {
        btn.classList.add('is-active');
      }
    });
  }
  if (urlTag) {
    tagButtons.forEach(btn => {
      if (btn.dataset.tag === decodeURIComponent(urlTag)) {
        btn.classList.add('is-active');
      }
    });
  }
  
  function filterArticles() {
    let visibleCount = 0;
    const query = searchQuery.toLowerCase().trim();
    
    articles.forEach(article => {
      const articleCategories = article.dataset.categories ? article.dataset.categories.split(',') : [];
      const articleTags = article.dataset.tags ? article.dataset.tags.split(',') : [];
      const articleTitle = article.dataset.title || '';
      const articleSummary = article.dataset.summary || '';
      
      // æ£€æŸ¥åˆ†ç±»
      const categoryMatch = currentCategory === 'all' || articleCategories.includes(currentCategory.toLowerCase());
      
      // æ£€æŸ¥æ ‡ç­¾ï¼ˆå¦‚æœé€‰ä¸­äº†æ ‡ç­¾ï¼Œæ–‡ç« å¿…é¡»åŒ…å«æ‰€æœ‰é€‰ä¸­çš„æ ‡ç­¾ï¼‰
      let tagMatch = true;
      if (selectedTags.size > 0) {
        tagMatch = [...selectedTags].every(tag => articleTags.includes(tag.toLowerCase()));
      }
      
      // æ£€æŸ¥æœç´¢å…³é”®è¯
      let searchMatch = true;
      if (query) {
        searchMatch = articleTitle.includes(query) || 
                     articleSummary.includes(query) ||
                     articleCategories.some(cat => cat.includes(query)) ||
                     articleTags.some(tag => tag.includes(query));
      }
      
      if (categoryMatch && tagMatch && searchMatch) {
        article.style.display = '';
        visibleCount++;
      } else {
        article.style.display = 'none';
      }
    });
    
    // æ›´æ–°æ ‡é¢˜å’Œè®¡æ•°
    let titleParts = [];
    if (query) {
      titleParts.push(`æœç´¢: "${query}"`);
    }
    if (currentCategory !== 'all') {
      titleParts.push(currentCategory);
    }
    if (selectedTags.size > 0) {
      titleParts.push([...selectedTags].join(' + '));
    }
    
    filterTitle.textContent = titleParts.length > 0 ? titleParts.join(' / ') : 'å…¨éƒ¨æ–‡ç« ';
    filterCount.textContent = visibleCount + ' ç¯‡';
    
    // æ˜¾ç¤º/éšè—æ— ç»“æœæç¤º
    if (visibleCount === 0) {
      noResults.style.display = '';
      articleList.style.display = 'none';
    } else {
      noResults.style.display = 'none';
      articleList.style.display = '';
    }
    
    // æ˜¾ç¤º/éšè—æ¸…é™¤åˆ†ç±»æŒ‰é’®
    if (resetCategoryBtn) {
      resetCategoryBtn.style.display = currentCategory !== 'all' ? '' : 'none';
    }
    
    // æ˜¾ç¤º/éšè—æ¸…é™¤æ ‡ç­¾æŒ‰é’®
    if (resetTagsBtn) {
      resetTagsBtn.style.display = selectedTags.size > 0 ? '' : 'none';
    }
  }
  
  // åˆ†ç±»ç‚¹å‡»äº‹ä»¶ï¼ˆå•é€‰ï¼‰
  categoryButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      categoryButtons.forEach(b => b.classList.remove('is-active'));
      this.classList.add('is-active');
      currentCategory = this.dataset.category;
      filterArticles();
    });
  });
  
  // æ¸…é™¤åˆ†ç±»æŒ‰é’®
  if (resetCategoryBtn) {
    resetCategoryBtn.addEventListener('click', function() {
      currentCategory = 'all';
      categoryButtons.forEach(btn => {
        btn.classList.remove('is-active');
        if (btn.dataset.category === 'all') {
          btn.classList.add('is-active');
        }
      });
      filterArticles();
    });
  }
  
  // æ ‡ç­¾ç‚¹å‡»äº‹ä»¶ï¼ˆå¤šé€‰ï¼‰
  tagButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const tag = this.dataset.tag;
      if (selectedTags.has(tag)) {
        selectedTags.delete(tag);
        this.classList.remove('is-active');
      } else {
        selectedTags.add(tag);
        this.classList.add('is-active');
      }
      filterArticles();
    });
  });
  
  // æ¸…é™¤æ ‡ç­¾æŒ‰é’®
  if (resetTagsBtn) {
    resetTagsBtn.addEventListener('click', function() {
      selectedTags.clear();
      tagButtons.forEach(btn => btn.classList.remove('is-active'));
      filterArticles();
    });
  }
  
  // æœç´¢åŠŸèƒ½
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      searchQuery = this.value;
      clearSearchBtn.style.display = searchQuery ? 'flex' : 'none';
      filterArticles();
    });
    
    // æ”¯æŒæŒ‰ ESC æ¸…é™¤æœç´¢
    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        this.value = '';
        searchQuery = '';
        clearSearchBtn.style.display = 'none';
        filterArticles();
      }
    });
  }
  
  // æ¸…é™¤æœç´¢æŒ‰é’®
  if (clearSearchBtn) {
    clearSearchBtn.addEventListener('click', function() {
      searchInput.value = '';
      searchQuery = '';
      this.style.display = 'none';
      filterArticles();
      searchInput.focus();
    });
  }
  
  // é¡µé¢åŠ è½½æ—¶åº”ç”¨åˆå§‹è¿‡æ»¤ï¼ˆå¦‚æœæœ‰ URL å‚æ•°ï¼‰
  if (urlCategory || urlTag) {
    filterArticles();
  }
})();
</script>
{{ end }}
